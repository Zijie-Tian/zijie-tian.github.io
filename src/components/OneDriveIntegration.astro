---
// OneDrive Integration Component
interface Props {
	folderPath?: string;
	clientId?: string;
}

const {
	folderPath = "/Blog",
	clientId = "4b36a6d5-66ae-4656-9b1f-d73b9a4f2163",
} = Astro.props;
---

<div id="onedrive-container" class="onedrive-container max-w-6xl mx-auto p-6" data-client-id={clientId} data-folder-path={folderPath}>
  <div class="text-center mb-8">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“ OneDrive æ–‡ä»¶ç®¡ç†</h2>
    <p class="text-gray-600">è¿æ¥ä½ çš„OneDriveï¼Œç®¡ç†å’Œåˆ†äº«æ–‡ä»¶</p>
  </div>
  
  <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
  <div id="auth-section" class="mb-8">
    <div id="login-button" class="hidden">
      <div class="auth-section">
        <div class="mb-4">
          <div class="text-4xl mb-3">â˜ï¸</div>
          <h3 class="text-xl font-semibold mb-2">è¿æ¥åˆ° OneDrive</h3>
          <p class="text-blue-100 mb-6">ç™»å½•ä½ çš„Microsoftè´¦æˆ·ä»¥è®¿é—®OneDriveæ–‡ä»¶</p>
        </div>
        <button 
          id="sign-in-btn" 
          class="sign-in-btn"
        >
          ğŸ” ç™»å½• Microsoft è´¦æˆ·
        </button>
      </div>
    </div>
    
    <div id="user-info" class="hidden">
      <div class="bg-white rounded-lg shadow-md p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="user-avatar w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold">
            <span id="user-initial">U</span>
          </div>
          <div>
            <p class="font-medium text-gray-800" id="user-name">å·²ç™»å½•ç”¨æˆ·</p>
            <p class="text-sm text-gray-500">OneDrive å·²è¿æ¥</p>
          </div>
        </div>
        <button 
          id="sign-out-btn" 
          class="text-sm text-red-600 hover:text-red-800 px-3 py-1 border border-red-200 rounded-md hover:bg-red-50 transition-colors"
        >
          é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  </div>

  <!-- æ–‡ä»¶åˆ—è¡¨ -->
  <div id="files-section" class="hidden">
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-xl font-semibold text-gray-800 flex items-center">
            <span class="mr-2">ğŸ“‚</span>
            <span id="current-folder">æ–‡ä»¶åˆ—è¡¨</span>
          </h3>
          <p class="text-sm text-gray-500 mt-1">å½“å‰è·¯å¾„: <span id="folder-path">/Blog</span></p>
        </div>
        <div class="flex space-x-2">
          <button 
            id="refresh-btn" 
            class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-3 py-2 rounded-md text-sm font-medium transition-colors flex items-center"
          >
            ğŸ”„ åˆ·æ–°
          </button>
        </div>
      </div>
      
      <div id="loading" class="hidden text-center py-12">
        <div class="loading-spinner inline-block w-8 h-8 border-2 rounded-full"></div>
        <p class="mt-4 text-gray-600 font-medium">æ­£åœ¨åŠ è½½æ–‡ä»¶...</p>
        <p class="text-sm text-gray-400">è¯·ç¨å€™</p>
      </div>
      
      <div id="files-list" class="file-grid"></div>
      
      <div id="empty-folder" class="hidden text-center py-12">
        <div class="text-6xl mb-4">ğŸ“­</div>
        <h4 class="text-lg font-medium text-gray-600 mb-2">æ–‡ä»¶å¤¹ä¸ºç©º</h4>
        <p class="text-gray-400">è¿™ä¸ªæ–‡ä»¶å¤¹ä¸­è¿˜æ²¡æœ‰ä»»ä½•æ–‡ä»¶</p>
      </div>
    </div>
    
    <div id="error-message" class="hidden error-message rounded-lg p-4 mt-4">
      <div class="flex items-center">
        <span class="text-2xl mr-3">âš ï¸</span>
        <div>
          <h4 class="font-medium text-red-800">å‡ºç°é”™è¯¯</h4>
          <p class="text-red-700 text-sm"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  // OneDrive é›†æˆè„šæœ¬
  class OneDriveManager {
    constructor(clientId, folderPath) {
      this.clientId = clientId;
      this.folderPath = folderPath;
      this.accessToken = null;
      this.init();
    }

    init() {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¿é—®ä»¤ç‰Œ
      this.accessToken = localStorage.getItem('onedrive_access_token');
      
      if (this.accessToken) {
        this.showUserInfo();
        this.loadFiles();
      } else {
        this.showLoginButton();
      }

      // ç»‘å®šäº‹ä»¶
      this.bindEvents();
    }

    bindEvents() {
      const signInBtn = document.getElementById('sign-in-btn');
      const signOutBtn = document.getElementById('sign-out-btn');
      const refreshBtn = document.getElementById('refresh-btn');

      if (signInBtn) {
        signInBtn.addEventListener('click', () => this.signIn());
      }

      if (signOutBtn) {
        signOutBtn.addEventListener('click', () => this.signOut());
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => this.loadFiles());
      }
    }

    showLoginButton() {
      document.getElementById('login-button').classList.remove('hidden');
      document.getElementById('user-info').classList.add('hidden');
      document.getElementById('files-section').classList.add('hidden');
    }

    showUserInfo() {
      document.getElementById('login-button').classList.add('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      document.getElementById('files-section').classList.remove('hidden');
      
      // è¿™é‡Œå¯ä»¥è°ƒç”¨Microsoft Graph APIè·å–ç”¨æˆ·ä¿¡æ¯
      // æš‚æ—¶æ˜¾ç¤ºå ä½ç¬¦
      document.getElementById('user-initial').textContent = 'U';
      document.getElementById('user-name').textContent = 'å·²ç™»å½•ç”¨æˆ·';
    }

    signIn() {
      // æ„å»ºMicrosoft OAuth2 æˆæƒURL
      const authUrl = new URL('https://login.microsoftonline.com/common/oauth2/v2.0/authorize');
      authUrl.searchParams.set('client_id', this.clientId);
      authUrl.searchParams.set('response_type', 'token');
      authUrl.searchParams.set('redirect_uri', window.location.origin + window.location.pathname);
      authUrl.searchParams.set('scope', 'Files.Read.All Files.ReadWrite.All User.Read');
      authUrl.searchParams.set('response_mode', 'fragment');

      // é‡å®šå‘åˆ°Microsoftç™»å½•é¡µé¢
      window.location.href = authUrl.toString();
    }

    signOut() {
      localStorage.removeItem('onedrive_access_token');
      this.accessToken = null;
      this.showLoginButton();
    }

    async loadFiles() {
      if (!this.accessToken) {
        this.showLoginButton();
        return;
      }

      this.showLoading(true);
      this.hideError();

      try {
        const response = await fetch(`/api/onedrive?access_token=${encodeURIComponent(this.accessToken)}&folder_path=${encodeURIComponent(this.folderPath)}`);
        const data = await response.json();

        if (data.success) {
          this.displayFiles(data.files);
        } else {
          this.showError(data.message || 'è·å–æ–‡ä»¶å¤±è´¥');
        }
      } catch (error) {
        console.error('Error loading files:', error);
        this.showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        this.showLoading(false);
      }
    }

    displayFiles(files) {
      const filesList = document.getElementById('files-list');
      const emptyFolder = document.getElementById('empty-folder');
      
      filesList.innerHTML = '';

      if (files.length === 0) {
        emptyFolder.classList.remove('hidden');
        filesList.classList.add('hidden');
        return;
      }

      emptyFolder.classList.add('hidden');
      filesList.classList.remove('hidden');

      files.forEach(file => {
        const fileElement = this.createFileElement(file);
        filesList.appendChild(fileElement);
      });
      
      // æ›´æ–°æ–‡ä»¶å¤¹è·¯å¾„æ˜¾ç¤º
      document.getElementById('folder-path').textContent = this.folderPath;
    }

    createFileElement(file) {
      const div = document.createElement('div');
      div.className = 'file-item p-4 rounded-lg cursor-pointer';
      
      const icon = file.isFolder ? 'ğŸ“' : this.getFileIcon(file.name);
      const size = file.size ? this.formatFileSize(file.size) : '';
      const date = new Date(file.lastModifiedDateTime).toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      div.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="file-icon flex-shrink-0 mt-1">
            ${icon}
          </div>
          <div class="flex-1 min-w-0">
            <h4 class="font-medium text-gray-900 truncate mb-1">${file.name}</h4>
            <div class="flex items-center text-xs text-gray-500 space-x-2">
              ${file.isFolder ? `
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full">
                  ğŸ“ æ–‡ä»¶å¤¹
                </span>
                ${file.childCount ? `<span>${file.childCount} é¡¹</span>` : ''}
              ` : `
                ${size ? `<span class="bg-gray-100 text-gray-700 px-2 py-1 rounded-full">${size}</span>` : ''}
                <span>ğŸ“… ${date}</span>
              `}
            </div>
          </div>
          <div class="flex-shrink-0">
            ${!file.isFolder ? `
              <a href="${file.webUrl}" target="_blank" 
                 class="inline-flex items-center px-3 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 text-xs font-medium rounded-md transition-colors"
                 onclick="event.stopPropagation()">
                <span class="mr-1">ğŸ‘ï¸</span>
                æŸ¥çœ‹
              </a>
            ` : `
              <div class="text-gray-400 text-xs">
                <span>ğŸ“‚</span>
              </div>
            `}
          </div>
        </div>
      `;

      // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæœªæ¥å¯ä»¥ç”¨äºæ–‡ä»¶å¤¹å¯¼èˆªï¼‰
      if (file.isFolder) {
        div.addEventListener('click', () => {
          console.log('ç‚¹å‡»æ–‡ä»¶å¤¹:', file.name);
          // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶å¤¹å¯¼èˆªåŠŸèƒ½
        });
      }

      return div;
    }

    getFileIcon(filename) {
      const ext = filename.toLowerCase().split('.').pop();
      const iconMap = {
        'md': 'ğŸ“', 'txt': 'ğŸ“„', 'pdf': 'ğŸ“•', 'doc': 'ğŸ“˜', 'docx': 'ğŸ“˜',
        'xls': 'ğŸ“—', 'xlsx': 'ğŸ“—', 'ppt': 'ğŸ“™', 'pptx': 'ğŸ“™',
        'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
        'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬',
        'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ',
        'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦'
      };
      return iconMap[ext] || 'ğŸ“„';
    }

    formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.remove('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }

    showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = errorDiv.querySelector('p');
      errorText.textContent = message;
      errorDiv.classList.remove('hidden');
      
      // è‡ªåŠ¨éšè—é”™è¯¯æ¶ˆæ¯
      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 5000);
    }

    hideError() {
      document.getElementById('error-message').classList.add('hidden');
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    // æ£€æŸ¥URLç‰‡æ®µä¸­æ˜¯å¦æœ‰è®¿é—®ä»¤ç‰Œï¼ˆOAuthå›è°ƒï¼‰
    const hash = window.location.hash;
    if (hash.includes('access_token=')) {
      const params = new URLSearchParams(hash.substring(1));
      const accessToken = params.get('access_token');
      if (accessToken) {
        localStorage.setItem('onedrive_access_token', accessToken);
        // æ¸…é™¤URLä¸­çš„ä»¤ç‰Œä¿¡æ¯
        window.location.hash = '';
      }
    }

    // åˆå§‹åŒ–OneDriveç®¡ç†å™¨
    const clientId = document.querySelector('#onedrive-container').dataset.clientId || 'YOUR_CLIENT_ID';
    const folderPath = document.querySelector('#onedrive-container').dataset.folderPath || '/Blog';
    
    new OneDriveManager(clientId, folderPath);
  });
</script>

<style>
  .onedrive-container {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  
  .file-item {
    transition: all 0.3s ease;
    border: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
  }
  
  .file-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border-color: #3b82f6;
  }
  
  .file-icon {
    font-size: 1.5rem;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  }
  
  .auth-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 2rem;
    color: white;
    text-align: center;
  }
  
  .sign-in-btn {
    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
  }
  
  .sign-in-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
  }
  
  .user-avatar {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
  }
  
  .loading-spinner {
    border-color: #e5e7eb;
    border-top-color: #3b82f6;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
  
  .error-message {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 1px solid #fca5a5;
    animation: slideIn 0.3s ease-out;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .file-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
  
  @media (max-width: 768px) {
    .file-grid {
      grid-template-columns: 1fr;
    }
    
    .onedrive-container {
      padding: 1rem;
    }
  }
</style> 