---
// OneDrive Integration Component
interface Props {
	folderPath?: string;
	clientId?: string;
}

const {
	folderPath = "/Blog",
	clientId = "4b36a6d5-66ae-4656-9b1f-d73b9a4f2163",
} = Astro.props;
---

<div id="onedrive-container" class="max-w-4xl mx-auto p-6" data-client-id={clientId} data-folder-path={folderPath}>
  <h2 class="text-2xl font-bold mb-6">OneDrive æ–‡ä»¶å¤¹å†…å®¹</h2>
  
  <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
  <div id="auth-section" class="mb-6">
    <div id="login-button" class="hidden">
      <button 
        id="sign-in-btn" 
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
      >
        ç™»å½• Microsoft è´¦æˆ·
      </button>
    </div>
    
    <div id="user-info" class="hidden">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
          <span id="user-initial"></span>
        </div>
        <div>
          <p class="font-medium" id="user-name"></p>
          <button 
            id="sign-out-btn" 
            class="text-sm text-gray-600 hover:text-gray-800 underline"
          >
            é€€å‡ºç™»å½•
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ–‡ä»¶åˆ—è¡¨ -->
  <div id="files-section" class="hidden">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold">æ–‡ä»¶åˆ—è¡¨</h3>
      <button 
        id="refresh-btn" 
        class="text-blue-600 hover:text-blue-800 text-sm underline"
      >
        åˆ·æ–°
      </button>
    </div>
    
    <div id="loading" class="hidden text-center py-8">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      <p class="mt-2 text-gray-600">åŠ è½½ä¸­...</p>
    </div>
    
    <div id="files-list" class="space-y-3"></div>
    
    <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mt-4">
      <p class="text-red-800"></p>
    </div>
  </div>
</div>

<script is:inline>
  // OneDrive é›†æˆè„šæœ¬
  class OneDriveManager {
    constructor(clientId, folderPath) {
      this.clientId = clientId;
      this.folderPath = folderPath;
      this.accessToken = null;
      this.init();
    }

    init() {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰è®¿é—®ä»¤ç‰Œ
      this.accessToken = localStorage.getItem('onedrive_access_token');
      
      if (this.accessToken) {
        this.showUserInfo();
        this.loadFiles();
      } else {
        this.showLoginButton();
      }

      // ç»‘å®šäº‹ä»¶
      this.bindEvents();
    }

    bindEvents() {
      const signInBtn = document.getElementById('sign-in-btn');
      const signOutBtn = document.getElementById('sign-out-btn');
      const refreshBtn = document.getElementById('refresh-btn');

      if (signInBtn) {
        signInBtn.addEventListener('click', () => this.signIn());
      }

      if (signOutBtn) {
        signOutBtn.addEventListener('click', () => this.signOut());
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', () => this.loadFiles());
      }
    }

    showLoginButton() {
      document.getElementById('login-button').classList.remove('hidden');
      document.getElementById('user-info').classList.add('hidden');
      document.getElementById('files-section').classList.add('hidden');
    }

    showUserInfo() {
      document.getElementById('login-button').classList.add('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      document.getElementById('files-section').classList.remove('hidden');
      
      // è¿™é‡Œå¯ä»¥è°ƒç”¨Microsoft Graph APIè·å–ç”¨æˆ·ä¿¡æ¯
      // æš‚æ—¶æ˜¾ç¤ºå ä½ç¬¦
      document.getElementById('user-initial').textContent = 'U';
      document.getElementById('user-name').textContent = 'å·²ç™»å½•ç”¨æˆ·';
    }

    signIn() {
      // æ„å»ºMicrosoft OAuth2 æˆæƒURL
      const authUrl = new URL('https://login.microsoftonline.com/common/oauth2/v2.0/authorize');
      authUrl.searchParams.set('client_id', this.clientId);
      authUrl.searchParams.set('response_type', 'token');
      authUrl.searchParams.set('redirect_uri', window.location.origin + window.location.pathname);
      authUrl.searchParams.set('scope', 'Files.Read.All Files.ReadWrite.All User.Read');
      authUrl.searchParams.set('response_mode', 'fragment');

      // é‡å®šå‘åˆ°Microsoftç™»å½•é¡µé¢
      window.location.href = authUrl.toString();
    }

    signOut() {
      localStorage.removeItem('onedrive_access_token');
      this.accessToken = null;
      this.showLoginButton();
    }

    async loadFiles() {
      if (!this.accessToken) {
        this.showLoginButton();
        return;
      }

      this.showLoading(true);
      this.hideError();

      try {
        const response = await fetch(`/api/onedrive?access_token=${encodeURIComponent(this.accessToken)}&folder_path=${encodeURIComponent(this.folderPath)}`);
        const data = await response.json();

        if (data.success) {
          this.displayFiles(data.files);
        } else {
          this.showError(data.message || 'è·å–æ–‡ä»¶å¤±è´¥');
        }
      } catch (error) {
        console.error('Error loading files:', error);
        this.showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
      } finally {
        this.showLoading(false);
      }
    }

    displayFiles(files) {
      const filesList = document.getElementById('files-list');
      filesList.innerHTML = '';

      if (files.length === 0) {
        filesList.innerHTML = '<p class="text-gray-500 text-center py-8">æ–‡ä»¶å¤¹ä¸ºç©º</p>';
        return;
      }

      files.forEach(file => {
        const fileElement = this.createFileElement(file);
        filesList.appendChild(fileElement);
      });
    }

    createFileElement(file) {
      const div = document.createElement('div');
      div.className = 'file-item bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border hover:shadow-md transition-shadow';
      
      const icon = file.isFolder ? 'ğŸ“' : this.getFileIcon(file.name);
      const size = file.size ? this.formatFileSize(file.size) : '';
      const date = new Date(file.lastModifiedDateTime).toLocaleDateString('zh-CN');

      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <span class="text-2xl">${icon}</span>
            <div>
              <h4 class="font-medium text-gray-900 dark:text-white">${file.name}</h4>
              <p class="text-sm text-gray-500 dark:text-gray-400">
                ${size} ${size && date ? 'â€¢' : ''} ${date}
              </p>
            </div>
          </div>
          <div class="flex space-x-2">
            ${!file.isFolder ? `
              <a href="${file.webUrl}" target="_blank" 
                 class="text-blue-600 hover:text-blue-800 text-sm underline">
                æŸ¥çœ‹
              </a>
            ` : ''}
          </div>
        </div>
      `;

      return div;
    }

    getFileIcon(filename) {
      const ext = filename.toLowerCase().split('.').pop();
      const iconMap = {
        'md': 'ğŸ“', 'txt': 'ğŸ“„', 'pdf': 'ğŸ“•', 'doc': 'ğŸ“˜', 'docx': 'ğŸ“˜',
        'xls': 'ğŸ“—', 'xlsx': 'ğŸ“—', 'ppt': 'ğŸ“™', 'pptx': 'ğŸ“™',
        'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸',
        'mp4': 'ğŸ¬', 'avi': 'ğŸ¬', 'mov': 'ğŸ¬',
        'mp3': 'ğŸµ', 'wav': 'ğŸµ', 'flac': 'ğŸµ',
        'zip': 'ğŸ“¦', 'rar': 'ğŸ“¦', '7z': 'ğŸ“¦'
      };
      return iconMap[ext] || 'ğŸ“„';
    }

    formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    showLoading(show) {
      const loading = document.getElementById('loading');
      if (show) {
        loading.classList.remove('hidden');
      } else {
        loading.classList.add('hidden');
      }
    }

    showError(message) {
      const errorDiv = document.getElementById('error-message');
      const errorText = errorDiv.querySelector('p');
      errorText.textContent = message;
      errorDiv.classList.remove('hidden');
    }

    hideError() {
      document.getElementById('error-message').classList.add('hidden');
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', () => {
    // æ£€æŸ¥URLç‰‡æ®µä¸­æ˜¯å¦æœ‰è®¿é—®ä»¤ç‰Œï¼ˆOAuthå›è°ƒï¼‰
    const hash = window.location.hash;
    if (hash.includes('access_token=')) {
      const params = new URLSearchParams(hash.substring(1));
      const accessToken = params.get('access_token');
      if (accessToken) {
        localStorage.setItem('onedrive_access_token', accessToken);
        // æ¸…é™¤URLä¸­çš„ä»¤ç‰Œä¿¡æ¯
        window.location.hash = '';
      }
    }

    // åˆå§‹åŒ–OneDriveç®¡ç†å™¨
    const clientId = document.querySelector('#onedrive-container').dataset.clientId || 'YOUR_CLIENT_ID';
    const folderPath = document.querySelector('#onedrive-container').dataset.folderPath || '/Blog';
    
    new OneDriveManager(clientId, folderPath);
  });
</script>

<style>
  .file-item {
    transition: transform 0.2s ease-in-out;
  }
  
  .file-item:hover {
    transform: translateY(-2px);
  }
  
  .blog-post-item {
    transition: all 0.2s ease-in-out;
  }
  
  .blog-post-item:hover {
    background-color: rgba(59, 130, 246, 0.05);
  }
  
  #files-section, #blog-posts-section {
    display: none;
  }
</style> 